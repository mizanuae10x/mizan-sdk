<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Knowledge Base - Mizan Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="mobile.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#060C18;
  --panel:#0b1f3a;
  --panel-soft:rgba(11,31,58,.7);
  --card:rgba(255,255,255,.03);
  --gold:#D4AF37;
  --gold-soft:rgba(212,175,55,.15);
  --text:#fff;
  --muted:rgba(255,255,255,.58);
  --danger:#ef4444;
  --ok:#34d399;
  --warn:#fbbf24;
}
body{font-family:'Inter',sans-serif;background:radial-gradient(circle at 20% 0%,#132d54 0%,var(--bg) 32%);color:var(--text);display:flex;min-height:100vh}
.sidebar{width:240px;background:#0B1F3A;padding:24px 0;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:10}
.sidebar .logo{padding:0 24px 24px;font-size:22px;font-weight:700;color:var(--gold);border-bottom:1px solid rgba(212,175,55,.2)}
.sidebar nav{flex:1;padding:16px 0}
.sidebar nav a{display:flex;align-items:center;gap:10px;padding:12px 24px;color:rgba(255,255,255,.7);text-decoration:none;font-size:14px;transition:all .2s}
.sidebar nav a:hover,.sidebar nav a.active{color:var(--gold);background:rgba(212,175,55,.08)}
.sidebar nav a.active{border-right:3px solid var(--gold)}
.sidebar .version{padding:16px 24px;font-size:12px;color:rgba(255,255,255,.3);border-top:1px solid rgba(212,175,55,.1)}
.main{margin-left:240px;flex:1;padding:24px 26px 20px;display:flex;flex-direction:column;height:100vh;overflow:hidden}
.hamburger{display:none;position:fixed;top:16px;left:16px;z-index:20;background:#0B1F3A;border:1px solid rgba(212,175,55,.3);color:var(--gold);font-size:24px;padding:8px 12px;border-radius:8px;cursor:pointer}
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:9}
.page-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.page-head h1{font-size:22px;color:var(--gold)}
.page-head p{font-size:13px;color:var(--muted)}
.grid{display:grid;grid-template-columns:minmax(320px,30%) minmax(0,70%);gap:16px;flex:1;min-height:0}
.panel{background:linear-gradient(180deg,rgba(12,30,55,.95),rgba(8,18,34,.95));border:1px solid rgba(212,175,55,.16);border-radius:14px;padding:16px;display:flex;flex-direction:column;min-height:0}
.panel-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.panel-title{font-size:17px;font-weight:600}
.badge{font-size:11px;padding:5px 10px;border-radius:999px;background:var(--gold-soft);color:var(--gold);font-weight:600}
.upload{background:var(--card);border:1px dashed rgba(212,175,55,.32);border-radius:12px;padding:12px;margin-bottom:12px}
label{font-size:12px;color:rgba(255,255,255,.72);display:block;margin:6px 0}
.input,textarea,select{width:100%;padding:10px 12px;background:rgba(0,0,0,.28);border:1px solid rgba(212,175,55,.2);border-radius:8px;color:#fff;font-family:inherit;font-size:13px}
textarea{resize:vertical;min-height:110px}
textarea:focus,.input:focus,select:focus{outline:none;border-color:var(--gold)}
.row{display:flex;gap:8px;align-items:center}
.btn{padding:10px 14px;border-radius:8px;border:0;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-gold{background:var(--gold);color:#0B1F3A}
.btn-gold:hover{background:#c9a430}
.btn-muted{background:rgba(255,255,255,.08);color:rgba(255,255,255,.85);border:1px solid rgba(255,255,255,.14)}
.btn-danger{background:rgba(239,68,68,.1);color:#fda4af;border:1px solid rgba(239,68,68,.4)}
.docs{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:4px}
.doc{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
.doc-top{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
.doc-name{font-size:13px;font-weight:600;line-height:1.35}
.doc-meta{margin-top:4px;font-size:11px;color:var(--muted)}
.stats{margin-top:10px;padding-top:10px;border-top:1px solid rgba(212,175,55,.18);font-size:12px;color:rgba(255,255,255,.72)}
.chat-wrap{display:flex;flex-direction:column;min-height:0;flex:1}
.chat-head{display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;border-bottom:1px solid rgba(212,175,55,.12);margin-bottom:10px}
.model{font-size:11px;padding:5px 10px;border-radius:999px;background:rgba(52,211,153,.12);color:#6ee7b7;font-weight:600}
.chat{flex:1;overflow:auto;padding-right:4px;display:flex;flex-direction:column;gap:10px}
.empty{margin:auto;color:rgba(255,255,255,.45);font-size:14px;text-align:center}
.msg{max-width:84%;padding:11px 13px;border-radius:12px;font-size:14px;line-height:1.45;white-space:pre-wrap}
.msg-user{align-self:flex-end;background:linear-gradient(180deg,#e6c15c,#d4af37);color:#10233f}
.msg-ai{align-self:flex-start;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
.sources{margin-top:8px;border-top:1px solid rgba(212,175,55,.15);padding-top:8px}
.sources summary{cursor:pointer;color:var(--gold);font-size:12px;font-weight:600}
.source{margin-top:7px;padding:8px;border:1px solid rgba(255,255,255,.08);border-radius:8px;background:rgba(0,0,0,.22)}
.src-head{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.72);margin-bottom:4px}
.src-body{font-size:12px;color:rgba(255,255,255,.7);line-height:1.4}
.input-wrap{margin-top:10px;border-top:1px solid rgba(212,175,55,.18);padding-top:10px}
.send-row{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:end}
.send-row textarea{min-height:56px;max-height:160px}
.spinner{width:16px;height:16px;border:2px solid rgba(212,175,55,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .75s linear infinite;display:inline-block;vertical-align:middle}
.notice{font-size:12px;color:var(--warn);margin-top:8px;display:none}
.notice.show{display:block}
@keyframes spin{to{transform:rotate(360deg)}}
@media (max-width:1024px){
  .grid{grid-template-columns:1fr}
  .main{height:auto;min-height:100vh;overflow:visible;padding-bottom:90px}
  .panel{min-height:420px}
}
</style>
</head>
<body>
<script>
(function(){
  var t=localStorage.getItem("mizanStudioToken");
  if(!t){window.location.href="/login.html";return;}
  fetch("/api/auth/me",{headers:{"Authorization":"Bearer "+t}})
    .then(function(r){if(r.status===401){localStorage.removeItem("mizanStudioToken");window.location.href="/login.html";}})
    .catch(function(){});
})();
</script>

<div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="logo">‚öñÔ∏è Mizan Studio</div>
  <nav>
    <a href="index.html">üè† Home</a>
    <a href="rules.html">üìã Rule Editor</a>
    <a href="decide.html">‚ö° Decision Tester</a>
    <a href="audit.html">üìä Audit Log</a>
    <a href="agents.html">ü§ñ Agent Monitor</a>
    <a href="compliance.html"><span>üá¶üá™</span> UAE Compliance</a>
    <a href="rag.html" class="active"><span>üìö</span> Knowledge Base</a>
    <a href="widget-demo.html"><span>üîå</span> Widget Demo</a>
    <a href="webhooks.html"><span>üîó</span> Webhooks</a>
    <a href="orchestration.html"><span>üîÄ</span> Multi-Agent</a>
    <a href="setup.html">‚öôÔ∏è Setup</a>
  <div style="position:absolute;bottom:20px;left:0;right:0;padding:0 12px;z-index:10;">
  <div style="background:#060C18;border:1px solid rgba(212,175,55,0.12);border-radius:10px;padding:12px;font-size:13px;text-align:center;">
    <div id="nav-user-name" style="color:#D4AF37;font-weight:600;margin-bottom:2px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ŸÖŸäÿ≤ÿßŸÜ</div>
    <div id="nav-user-email" style="font-size:11px;color:#475569;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
    <button id="nav-logout-btn" style="background:#D4AF37;color:#060C18;border:none;border-radius:6px;padding:5px 0;cursor:pointer;font-size:12px;font-weight:700;width:100%;font-family:inherit;">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
  </div>
</div>
<script>
(function(){
  var t=localStorage.getItem("mizanStudioToken");
  if(!t)return;
  fetch("/api/auth/me",{headers:{"Authorization":"Bearer "+t}})
    .then(function(r){return r.json();})
    .then(function(d){
      if(d.user){
        var n=document.getElementById("nav-user-name");
        var e=document.getElementById("nav-user-email");
        if(n)n.textContent=d.user.name||"Admin";
        if(e)e.textContent=d.user.email||"";
      }
    }).catch(function(){});
  var btn=document.getElementById("nav-logout-btn");
  if(btn)btn.onclick=function(){
    var tok=localStorage.getItem("mizanStudioToken")||"";
    localStorage.removeItem("mizanStudioToken");
    fetch("/api/auth/logout",{method:"POST",headers:{"Authorization":"Bearer "+tok}});
    window.location.href="/login.html";
  };
})();
</script>
</nav>
  <div class="version">üì¶ v1.1.0</div>
</div>
<div class="main">
  <div class="page-head">
    <div>
      <h1>üìö Knowledge Base Studio</h1>
      <p>Ingest documents, run semantic retrieval, and chat with grounded sources.</p>
    </div>
  </div>

  <div class="grid">
    <section class="panel">
      <div class="panel-head">
        <div class="panel-title">üìö Knowledge Base</div>
        <span class="badge" id="docCountBadge">0 docs</span>
      </div>

      <div class="upload">
        <label for="docName">Document Name</label>
        <input id="docName" class="input" placeholder="e.g., UAE Policy Handbook">

        <!-- File Drop Zone -->
        <div id="dropZone" style="border:2px dashed rgba(212,175,55,0.3);border-radius:10px;padding:18px;text-align:center;cursor:pointer;margin:10px 0;transition:border-color 0.2s,background 0.2s;" ondragover="event.preventDefault();this.style.borderColor='#D4AF37';this.style.background='rgba(212,175,55,0.06)';" ondragleave="this.style.borderColor='rgba(212,175,55,0.3)';this.style.background='transparent';" ondrop="handleFileDrop(event);" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" style="display:none" accept=".txt,.md,.pdf,.docx,.csv,.json,.html" onchange="handleFileSelect(this)">
          <div style="font-size:22px;margin-bottom:6px">üìé</div>
          <div style="font-size:13px;color:#D4AF37;font-weight:600;">ÿ±ŸÅÿπ ŸÖŸÑŸÅ / Drop File or Click</div>
          <div style="font-size:11px;color:#64748b;margin-top:3px;">TXT ¬∑ MD ¬∑ PDF ¬∑ DOCX ¬∑ CSV ¬∑ JSON</div>
          <div id="fileSelectedName" style="font-size:12px;color:#D4AF37;margin-top:6px;display:none;"></div>
        </div>

        <label for="docContent" style="margin-top:4px;display:block;">ÿ£Ÿà ÿßŸÑÿµŸÇ ÿßŸÑŸÜÿµ / Or Paste Content</label>
        <textarea id="docContent" placeholder="Paste text content here..."></textarea>

        <!-- Duplicate warning -->
        <div id="dupWarning" style="display:none;background:rgba(234,179,8,0.1);border:1px solid rgba(234,179,8,0.3);border-radius:8px;padding:10px 12px;margin-top:8px;font-size:12px;">
          <div style="color:#fbbf24;font-weight:600;margin-bottom:4px;">‚ö†Ô∏è ŸÖÿ≥ÿ™ŸÜÿØ ŸÖŸÉÿ±ÿ± / Duplicate Document Detected</div>
          <div id="dupMessage" style="color:#94a3b8;margin-bottom:8px;"></div>
          <button class="btn" onclick="forceIngest()" style="background:#D4AF37;color:#060C18;font-size:12px;padding:5px 14px;font-weight:700;">ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ / Replace Anyway</button>
          <button class="btn" onclick="document.getElementById('dupWarning').style.display='none'" style="background:transparent;border:1px solid rgba(212,175,55,0.3);color:#D4AF37;font-size:12px;padding:5px 14px;margin-right:6px;">ÿ•ŸÑÿ∫ÿßÿ° / Cancel</button>
        </div>

        <div class="row" style="margin-top:8px;justify-content:space-between">
          <button class="btn btn-gold" id="ingestBtn">‚¨ÜÔ∏è Ingest Document</button>
          <span id="ingestStatus" style="font-size:12px;color:var(--muted)"></span>
        </div>
      </div>

      <div class="docs" id="docsList">
        <div class="doc"><div class="doc-meta">No documents yet.</div></div>
      </div>

      <div class="stats" id="statsBar">0 docs ¬∑ 0 chunks ¬∑ Embeddings: ‚ö†Ô∏è</div>
      <div id="ragNotice" class="notice">RAG API unavailable. Run `npm run build` and restart Studio.</div>
    </section>

    <section class="panel chat-wrap">
      <div class="chat-head">
        <div class="panel-title">üí¨ Chat with Documents</div>
        <span class="model">gpt-4o-mini</span>
      </div>
      <div class="chat" id="chatBox">
        <div class="empty" id="emptyState">Upload documents to start chatting with your knowledge base</div>
      </div>
      <div class="input-wrap">
        <div class="send-row">
          <textarea id="queryInput" placeholder="Ask your knowledge base..."></textarea>
          <select id="topK">
            <option value="1">Top-K: 1</option>
            <option value="3" selected>Top-K: 3</option>
            <option value="5">Top-K: 5</option>
          </select>
          <button class="btn btn-gold" id="sendBtn">Send</button>
          <button class="btn btn-muted" id="clearBtn">Clear Chat</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('show')}

const docsList=document.getElementById('docsList');
const chatBox=document.getElementById('chatBox');
const emptyState=document.getElementById('emptyState');
const ragNotice=document.getElementById('ragNotice');

function showNotice(show){ragNotice.classList.toggle('show',!!show)}
function fmtDate(iso){try{return new Date(iso).toLocaleString()}catch{return iso||''}}
function score(v){return typeof v==='number' ? (v*100).toFixed(1)+'%' : '-'}
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

async function api(path, opts={}){
  const r=await fetch(path,{headers:{'Content-Type':'application/json'},...opts});
  let data=null;
  try{data=await r.json()}catch{}
  if(!r.ok) throw new Error(data?.error||('Request failed: '+r.status));
  return data;
}

function setIngestStatus(text, loading=false){
  document.getElementById('ingestStatus').innerHTML=loading?`<span class="spinner"></span> ${text}`:text;
}

function renderDocs(docs){
  if(!docs.length){
    docsList.innerHTML='<div class="doc"><div class="doc-meta">No documents yet.</div></div>';
    return;
  }
  docsList.innerHTML=docs.map(d=>`<div class="doc">
    <div class="doc-top">
      <div>
        <div class="doc-name">üìÑ ${esc(d.name)}</div>
        <div class="doc-meta">${fmtDate(d.createdAt)}</div>
      </div>
      <div class="row">
        <span class="badge">${d.chunkCount||0} chunks</span>
        <button class="btn btn-danger" style="padding:6px 10px" data-id="${esc(d.id)}">üóëÔ∏è</button>
      </div>
    </div>
  </div>`).join('');

  docsList.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.addEventListener('click',async()=>{
      const id=btn.getAttribute('data-id');
      if(!confirm('Delete this document from the knowledge base?')) return;
      try{
        await api('/api/rag/docs/'+id,{method:'DELETE'});
        await refreshKB();
      }catch(e){alert(e.message)}
    });
  });
}

function addMessage(role,text,sources){
  emptyState.style.display='none';
  const msg=document.createElement('div');
  msg.className='msg '+(role==='user'?'msg-user':'msg-ai');
  msg.textContent=text;

  if(role==='ai'&&Array.isArray(sources)&&sources.length){
    const details=document.createElement('details');
    details.className='sources';
    details.innerHTML=`<summary>üìé Sources (${sources.length})</summary>`;
    sources.forEach((s,i)=>{
      const wrap=document.createElement('div');
      wrap.className='source';
      wrap.innerHTML=`<div class="src-head"><span>Source [${i+1}] ${esc(s.chunk?.docName||'Unknown')}</span><span>${score(s.score)}</span></div><div class="src-body">${esc((s.chunk?.text||'').slice(0,260))}${(s.chunk?.text||'').length>260?'...':''}</div>`;
      details.appendChild(wrap);
    });
    msg.appendChild(details);
  }

  chatBox.appendChild(msg);
  chatBox.scrollTop=chatBox.scrollHeight;
}

async function refreshKB(){
  try{
    const [docs,stats]=await Promise.all([api('/api/rag/docs'),api('/api/rag/stats')]);
    showNotice(false);
    document.getElementById('docCountBadge').textContent=`${docs.length} docs`;
    document.getElementById('statsBar').textContent=`${stats.documentCount||0} docs ¬∑ ${stats.chunkCount||0} chunks ¬∑ Embeddings: ${stats.hasEmbeddings?'‚úÖ':'‚ö†Ô∏è'}`;
    renderDocs(docs);
  }catch(e){
    showNotice(true);
    document.getElementById('docCountBadge').textContent='0 docs';
    document.getElementById('statsBar').textContent='0 docs ¬∑ 0 chunks ¬∑ Embeddings: ‚ö†Ô∏è';
    renderDocs([]);
  }
}

// File upload state
let _pendingFileBase64 = null;
let _pendingFileMime = null;

function handleFileSelect(input) {
  const file = input.files[0];
  if (!file) return;
  readFileForIngest(file);
}

function handleFileDrop(event) {
  event.preventDefault();
  document.getElementById('dropZone').style.borderColor = 'rgba(212,175,55,0.3)';
  document.getElementById('dropZone').style.background = 'transparent';
  const file = event.dataTransfer.files[0];
  if (!file) return;
  readFileForIngest(file);
}

function readFileForIngest(file) {
  _pendingFileBase64 = null;
  _pendingFileMime = null;
  const nameInput = document.getElementById('docName');
  if (!nameInput.value.trim()) nameInput.value = file.name;
  const nameEl = document.getElementById('fileSelectedName');
  nameEl.textContent = '‚úÖ ' + file.name + ' (' + (file.size/1024).toFixed(1) + ' KB)';
  nameEl.style.display = 'block';

  // For text files, read as text directly
  const ext = file.name.split('.').pop().toLowerCase();
  if (['txt','md','csv','json','html','xml','rst'].includes(ext)) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('docContent').value = e.target.result;
      _pendingFileBase64 = null;
    };
    reader.readAsText(file);
  } else {
    // Binary files: read as base64
    const reader = new FileReader();
    reader.onload = function(e) {
      const dataUrl = e.target.result;
      _pendingFileBase64 = dataUrl.split(',')[1];
      _pendingFileMime = file.type;
      document.getElementById('docContent').value = '';
    };
    reader.readAsDataURL(file);
  }
}

async function doIngest(force = false) {
  const name = document.getElementById('docName').value.trim();
  const content = document.getElementById('docContent').value.trim();
  const base64Content = _pendingFileBase64;
  const mimeType = _pendingFileMime;

  if (!name) { alert('Document name is required.'); return; }
  if (!content && !base64Content) { alert('Please paste content or upload a file.'); return; }

  document.getElementById('dupWarning').style.display = 'none';
  setIngestStatus('Ingesting...', true);

  try {
    const body = { name, force };
    if (content) body.content = content;
    if (base64Content) { body.base64Content = base64Content; body.mimeType = mimeType; }

    const res = await fetch('/api/rag/ingest', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (localStorage.getItem('mizanStudioToken') || '') },
      body: JSON.stringify(body)
    });
    const data = await res.json();

    if (res.status === 409 && data.duplicate) {
      // Show duplicate warning
      setIngestStatus('');
      document.getElementById('dupMessage').textContent =
        (data.duplicateType === 'hash' ? 'üìã Same content already exists as: ' : 'üìÅ Same name already exists: ') +
        data.doc.name + ' (created ' + new Date(data.doc.createdAt).toLocaleDateString('ar-AE') + ')';
      document.getElementById('dupWarning').style.display = 'block';
      return;
    }

    if (!res.ok) throw new Error(data.error || 'Ingest failed');

    document.getElementById('docContent').value = '';
    document.getElementById('docName').value = '';
    document.getElementById('fileSelectedName').style.display = 'none';
    document.getElementById('fileInput').value = '';
    _pendingFileBase64 = null;
    _pendingFileMime = null;
    setIngestStatus('‚úÖ Ingested ‚Äî ' + data.chunkCount + ' chunks');
    await refreshKB();
  } catch(e) {
    setIngestStatus('');
    alert(e.message);
  }
}

function forceIngest() {
  document.getElementById('dupWarning').style.display = 'none';
  doIngest(true);
}

document.getElementById('ingestBtn').addEventListener('click', () => doIngest(false));

document.getElementById('sendBtn').addEventListener('click',sendQuery);
document.getElementById('queryInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendQuery();}
});

document.getElementById('clearBtn').addEventListener('click',()=>{
  chatBox.innerHTML='';
  emptyState.style.display='block';
  chatBox.appendChild(emptyState);
});

async function sendQuery(){
  const queryEl=document.getElementById('queryInput');
  const query=queryEl.value.trim();
  if(!query) return;
  const topK=Number(document.getElementById('topK').value||3);

  addMessage('user',query);
  queryEl.value='';

  const pending=document.createElement('div');
  pending.className='msg msg-ai';
  pending.innerHTML='<span class="spinner"></span> Thinking...';
  chatBox.appendChild(pending);
  chatBox.scrollTop=chatBox.scrollHeight;

  try{
    const result=await api('/api/rag/query',{method:'POST',body:JSON.stringify({query,topK})});
    pending.remove();
    addMessage('ai',result.answer||'No answer returned.',result.sources||[]);
    showNotice(false);
  }catch(e){
    pending.remove();
    addMessage('ai','Request failed: '+e.message,[]);
    if(String(e.message).includes('RAG not available')) showNotice(true);
  }
}

refreshKB();
</script>
</body>
</html>
