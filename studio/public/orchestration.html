<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mizan Studio - Multi-Agent Orchestration</title>
<link rel="stylesheet" href="mobile.css" />
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(145deg,#0A1628,#102746 55%,#1a2f4f);color:#fff;min-height:100vh}
.sidebar{width:240px;background:#0B1F3A;padding:24px 0;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:10}
.sidebar .logo{padding:0 24px 24px;font-size:22px;font-weight:700;color:#D4AF37;border-bottom:1px solid rgba(212,175,55,.2)}
.sidebar nav{flex:1;padding:16px 0;overflow:auto}
.sidebar nav a{display:flex;align-items:center;gap:10px;padding:12px 24px;color:rgba(255,255,255,.7);text-decoration:none;font-size:14px;transition:all .2s}
.sidebar nav a:hover,.sidebar nav a.active{color:#D4AF37;background:rgba(212,175,55,.08)}
.sidebar nav a.active{border-right:3px solid #D4AF37}
.sidebar .version{padding:16px 24px;font-size:12px;color:rgba(255,255,255,.3);border-top:1px solid rgba(212,175,55,.1)}
.main{margin-left:240px;padding:24px}
h1{font-size:28px;color:#D4AF37;margin-bottom:18px}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(212,175,55,.25);border-radius:12px;padding:16px;margin-bottom:16px}
.card h2{font-size:18px;color:#D4AF37;margin-bottom:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.2);color:#fff}
textarea{min-height:92px;resize:vertical}
button{background:#D4AF37;color:#0A1628;border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer}
button.secondary{background:rgba(255,255,255,.15);color:#fff}
button.danger{background:#ef4444;color:#fff}
.step{border:1px solid rgba(212,175,55,.2);background:rgba(0,0,0,.2);border-radius:10px;padding:12px;margin-bottom:10px;position:relative}
.arrow{color:#D4AF37;text-align:center;font-size:20px;margin:-4px 0 6px}
.template-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
.template{border:1px solid rgba(212,175,55,.2);padding:12px;border-radius:10px;background:rgba(0,0,0,.2)}
.template p{font-size:13px;opacity:.85;margin:6px 0}
.template ol{font-size:12px;opacity:.85;padding-left:18px;margin-bottom:8px}
.timeline-item{border-left:2px solid #D4AF37;padding-left:12px;margin-bottom:14px}
.role-badge{display:inline-block;padding:3px 7px;border-radius:999px;background:rgba(212,175,55,.2);color:#D4AF37;font-size:12px;font-weight:700}
.final{padding:12px;border-radius:10px;background:rgba(212,175,55,.12);border:1px solid rgba(212,175,55,.3)}
.mobile-menu-btn{display:none}
.overlay{display:none}
@media (max-width:900px){.main{margin-left:0}}
</style>
</head>
<body>
<script>
(function(){
  var t=localStorage.getItem("mizanStudioToken");
  if(!t){window.location.href="/login.html";return;}
  fetch("/api/auth/me",{headers:{"Authorization":"Bearer "+t}})
    .then(function(r){if(r.status===401){localStorage.removeItem("mizanStudioToken");window.location.href="/login.html";}})
    .catch(function(){});
})();
</script>

<button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="logo">‚öñÔ∏è Mizan Studio</div>
  <nav>
    <a href="index.html">üè† Home</a>
    <a href="rules.html">üìã Rule Editor</a>
    <a href="decide.html">‚ö° Decision Tester</a>
    <a href="audit.html">üìä Audit Log</a>
    <a href="agents.html">ü§ñ Agent Monitor</a>
    <a href="compliance.html"><span>üá¶üá™</span> UAE Compliance</a>
    <a href="rag.html"><span>üìö</span> Knowledge Base</a>
    <a href="widget-demo.html"><span>üîå</span> Widget Demo</a>
    <a href="webhooks.html"><span>üîó</span> Webhooks</a>
    <a href="orchestration.html" class="active"><span>üîÄ</span> Multi-Agent</a>
    <a href="setup.html">‚öôÔ∏è Setup</a>
  <div style="position:absolute;bottom:20px;left:0;right:0;padding:0 12px;z-index:10;">
  <div style="background:#060C18;border:1px solid rgba(212,175,55,0.12);border-radius:10px;padding:12px;font-size:13px;text-align:center;">
    <div id="nav-user-name" style="color:#D4AF37;font-weight:600;margin-bottom:2px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ŸÖŸäÿ≤ÿßŸÜ</div>
    <div id="nav-user-email" style="font-size:11px;color:#475569;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
    <button id="nav-logout-btn" style="background:#D4AF37;color:#060C18;border:none;border-radius:6px;padding:5px 0;cursor:pointer;font-size:12px;font-weight:700;width:100%;font-family:inherit;">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
  </div>
</div>
<script>
(function(){
  var t=localStorage.getItem("mizanStudioToken");
  if(!t)return;
  fetch("/api/auth/me",{headers:{"Authorization":"Bearer "+t}})
    .then(function(r){return r.json();})
    .then(function(d){
      if(d.user){
        var n=document.getElementById("nav-user-name");
        var e=document.getElementById("nav-user-email");
        if(n)n.textContent=d.user.name||"Admin";
        if(e)e.textContent=d.user.email||"";
      }
    }).catch(function(){});
  var btn=document.getElementById("nav-logout-btn");
  if(btn)btn.onclick=function(){
    var tok=localStorage.getItem("mizanStudioToken")||"";
    localStorage.removeItem("mizanStudioToken");
    fetch("/api/auth/logout",{method:"POST",headers:{"Authorization":"Bearer "+tok}});
    window.location.href="/login.html";
  };
})();
</script>
</nav>
  <div class="version">v1.0.0</div>
</div>

<div class="main">
  <h1>üîÄ Multi-Agent Orchestration</h1>

  <section class="card">
    <h2>Pipeline Builder</h2>
    <div class="row" style="margin-bottom:10px">
      <input id="pipelineName" placeholder="Pipeline name" style="max-width:300px" />
      <button class="secondary" onclick="addStep()">Add Step</button>
    </div>
    <div id="steps"></div>
    <div class="row" style="margin-top:8px">
      <textarea id="inputMessage" placeholder="Input message for pipeline run..."></textarea>
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="runPipeline()">Run Pipeline</button>
    </div>
  </section>

  <section class="card">
    <h2>Templates (3 preset pipelines)</h2>
    <div class="template-grid" id="templates"></div>
  </section>

  <section class="card">
    <h2>Results Panel</h2>
    <div id="results">Run a pipeline to see step outputs.</div>
  </section>
</div>

<script>
let agents = [];
let templates = [];
let steps = [];

function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('show')}
function esc(s){return String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

async function loadAgents(){
  agents = await (await fetch('/api/agents')).json();
}

async function loadTemplates(){
  templates = await (await fetch('/api/orchestrate/templates')).json();
  const wrap = document.getElementById('templates');
  wrap.innerHTML = templates.map((t, i) => `
    <div class="template">
      <strong>${esc(t.name)}</strong>
      <p>${esc(t.description)}</p>
      <ol>${(t.steps || []).map((s, idx) => `<li>${idx + 1}. ${esc(s.role)}</li>`).join('')}</ol>
      <button class="secondary" onclick="useTemplate(${i})">Use Template</button>
    </div>
  `).join('');
}

function defaultStep(){
  return { agentId: agents[0]?.id || '', role: 'Agent', passOutputAsInput: true };
}

function addStep(step){
  steps.push(step || defaultStep());
  renderSteps();
}

function removeStep(i){ steps.splice(i, 1); renderSteps(); }

function setStep(i, key, val){ steps[i][key] = val; }

function renderSteps(){
  const el = document.getElementById('steps');
  if (!steps.length) {
    el.innerHTML = '<div style="opacity:.7">No steps yet. Add at least one step.</div>';
    return;
  }
  el.innerHTML = steps.map((s, i) => {
    const opts = agents.map(a => `<option value="${a.id}" ${a.id === s.agentId ? 'selected' : ''}>${esc(a.name)}</option>`).join('');
    return `
      <div class="step">
        <div style="font-weight:700;margin-bottom:8px">Step ${i + 1}</div>
        <div class="row">
          <div style="flex:1;min-width:170px"><label>Agent</label><select onchange="setStep(${i},'agentId',this.value)">${opts}</select></div>
          <div style="flex:1;min-width:170px"><label>Role label</label><input value="${esc(s.role)}" oninput="setStep(${i},'role',this.value)" /></div>
          <div style="min-width:140px"><label>Pass output</label><select onchange="setStep(${i},'passOutputAsInput',this.value==='true')"><option value="true" ${s.passOutputAsInput !== false ? 'selected' : ''}>On</option><option value="false" ${s.passOutputAsInput === false ? 'selected' : ''}>Off</option></select></div>
          <div><label>&nbsp;</label><button class="danger" onclick="removeStep(${i})">Remove</button></div>
        </div>
      </div>
      ${i < steps.length - 1 ? '<div class="arrow">‚Üí</div>' : ''}
    `;
  }).join('');
}

function useTemplate(i){
  const t = templates[i];
  steps = (t.steps || []).map(s => ({
    agentId: agents[0]?.id || '',
    role: s.role || 'Agent',
    passOutputAsInput: true
  }));
  document.getElementById('pipelineName').value = t.name || '';
  renderSteps();
}

async function runPipeline(){
  if (!steps.length) return alert('Add at least one step');
  const pipeline = steps.map(s => ({ agentId: s.agentId, role: s.role, passOutputAsInput: s.passOutputAsInput !== false }));
  if (pipeline.some(s => !s.agentId)) return alert('Every step must select an agent');
  const input = document.getElementById('inputMessage').value.trim();
  const res = await fetch('/api/orchestrate', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ pipeline, input: { message: input }, sessionId: 'ui-' + Date.now().toString(36) })
  });
  const data = await res.json();
  if (!res.ok) return alert(data.error || 'Pipeline failed');
  renderResults(data);
}

function renderResults(data){
  const nameById = Object.fromEntries(agents.map(a => [a.id, a.name]));
  const html = (data.results || []).map(r => `
    <div class="timeline-item">
      <div><strong>Step ${r.step}</strong> <span class="role-badge">${esc(r.role || '')}</span></div>
      <div style="font-size:13px;opacity:.85">Agent: ${esc(nameById[r.agentId] || r.agentId || '-')}</div>
      <details style="margin:6px 0"><summary>Answer</summary><div style="white-space:pre-wrap;margin-top:4px">${esc(r.answer || r.error || '')}</div></details>
      <div style="font-size:12px;opacity:.9">Compliance: ${r.compliance?.score ?? '-'}</div>
      <div style="font-size:12px;opacity:.8">Audit Hash: ${esc(r.auditHash || '-')}</div>
    </div>
  `).join('');
  document.getElementById('results').innerHTML = html + `
    <div class="final">
      <strong>Final Answer</strong>
      <div id="finalAnswer" style="white-space:pre-wrap;margin:8px 0">${esc(data.finalAnswer || '')}</div>
      <button class="secondary" onclick="copyFinal()">Copy Final Answer</button>
    </div>
  `;
}

async function copyFinal(){
  const text = document.getElementById('finalAnswer')?.innerText || '';
  try { await navigator.clipboard.writeText(text); } catch {}
}

(async function init(){
  await loadAgents();
  await loadTemplates();
  addStep();
})();
</script>
</body>
</html>
