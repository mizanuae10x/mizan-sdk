<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agent Builder â€” Mizan Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="mobile.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#060C18;color:#fff;display:flex;min-height:100vh}
.sidebar{width:240px;background:#0B1F3A;padding:24px 0;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:10}
.sidebar .logo{padding:0 24px 24px;font-size:22px;font-weight:700;color:#D4AF37;border-bottom:1px solid rgba(212,175,55,.2)}
.sidebar nav{flex:1;padding:16px 0}
.sidebar nav a{display:flex;align-items:center;gap:10px;padding:12px 24px;color:rgba(255,255,255,.7);text-decoration:none;font-size:14px;transition:all .2s}
.sidebar nav a:hover,.sidebar nav a.active{color:#D4AF37;background:rgba(212,175,55,.08)}
.sidebar nav a.active{border-right:3px solid #D4AF37}
.sidebar .version{padding:16px 24px;font-size:12px;color:rgba(255,255,255,.3);border-top:1px solid rgba(212,175,55,.1)}
.main{margin-left:240px;flex:1;padding:40px}
.hamburger{display:none;position:fixed;top:16px;left:16px;z-index:20;background:#0B1F3A;border:1px solid rgba(212,175,55,.3);color:#D4AF37;font-size:24px;padding:8px 12px;border-radius:8px;cursor:pointer}
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:9}
h1{font-size:28px;margin-bottom:8px}
.subtitle{color:rgba(255,255,255,.5);margin-bottom:24px;font-size:14px}
.btn{padding:10px 24px;background:#D4AF37;color:#0B1F3A;font-weight:600;border-radius:8px;border:none;cursor:pointer;font-size:14px;transition:all .2s}
.btn:hover{background:#c9a430}
.btn-outline{background:transparent;border:1px solid rgba(212,175,55,.4);color:#D4AF37}
.btn-outline:hover{background:rgba(212,175,55,.1)}
.btn-green{background:#34d399;color:#0B1F3A}
.btn-green:hover{background:#2fc78d}
.btn-red{background:transparent;border:1px solid rgba(239,68,68,.4);color:#ef4444}
.btn-red:hover{background:rgba(239,68,68,.1)}
.btn-sm{padding:6px 14px;font-size:12px}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-bottom:24px}
.agent-card{background:rgba(11,31,58,.8);border:1px solid rgba(212,175,55,.15);border-radius:12px;padding:24px;transition:all .2s}
.agent-card:hover{border-color:rgba(212,175,55,.4)}
.agent-card .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.agent-card h3{font-size:16px;color:#D4AF37}
.agent-card .type-badge{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase}
.type-governance{background:rgba(52,211,153,.15);color:#34d399}
.type-research{background:rgba(96,165,250,.15);color:#60a5fa}
.type-chat{background:rgba(168,85,247,.15);color:#a855f7}
.type-compliance{background:rgba(251,191,36,.15);color:#fbbf24}
.type-data{background:rgba(244,114,182,.15);color:#f472b6}
.type-custom{background:rgba(255,255,255,.1);color:rgba(255,255,255,.6)}
.agent-card .desc{font-size:13px;color:rgba(255,255,255,.5);margin-bottom:16px;line-height:1.5}
.agent-card .meta{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;color:rgba(255,255,255,.4);margin-bottom:16px}
.agent-card .actions{display:flex;gap:8px;flex-wrap:wrap}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.dot-idle{background:rgba(255,255,255,.3)}
.dot-running{background:#34d399;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.modal-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:flex-start;padding-top:40px;overflow-y:auto}
.modal-bg.show{display:flex}
.modal{background:#0B1F3A;border:1px solid rgba(212,175,55,.2);border-radius:16px;padding:32px;width:700px;max-width:95%;margin-bottom:40px}
.modal h2{font-size:22px;color:#D4AF37;margin-bottom:8px}
.modal .modal-subtitle{color:rgba(255,255,255,.4);font-size:13px;margin-bottom:24px}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:13px;color:rgba(255,255,255,.6);margin-bottom:6px;font-weight:500}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;background:rgba(255,255,255,.05);border:1px solid rgba(212,175,55,.2);border-radius:8px;color:#fff;font-size:14px;font-family:inherit}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#D4AF37}
.form-group select option{background:#0B1F3A}
.form-group .hint{font-size:11px;color:rgba(255,255,255,.3);margin-top:4px}
.type-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:8px}
.type-option{padding:14px 12px;background:rgba(255,255,255,.03);border:2px solid rgba(255,255,255,.08);border-radius:10px;cursor:pointer;text-align:center;transition:all .2s}
.type-option:hover{border-color:rgba(212,175,55,.3)}
.type-option.selected{border-color:#D4AF37;background:rgba(212,175,55,.08)}
.type-option .emoji{font-size:24px;margin-bottom:6px}
.type-option .name{font-size:13px;font-weight:600;margin-bottom:2px}
.type-option .tdesc{font-size:11px;color:rgba(255,255,255,.4)}
.tools-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.tool-check{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:8px;cursor:pointer;transition:all .2s}
.tool-check:hover{border-color:rgba(212,175,55,.3)}
.tool-check.checked{border-color:#D4AF37;background:rgba(212,175,55,.08)}
.tool-check input[type=checkbox]{display:none}
.tool-check .tname{font-size:13px;font-weight:500}
.tool-check .tdesc2{font-size:11px;color:rgba(255,255,255,.4)}
.rule-row{display:grid;grid-template-columns:1fr 1.5fr auto 60px 30px;gap:8px;margin-bottom:8px;align-items:center}
.rule-row input,.rule-row select{padding:8px 10px;background:rgba(255,255,255,.05);border:1px solid rgba(212,175,55,.15);border-radius:6px;color:#fff;font-size:13px;font-family:inherit}
.rule-row select option{background:#0B1F3A}
.rule-row .remove-rule{background:none;border:none;color:#ef4444;cursor:pointer;font-size:18px;padding:4px}
.run-output{background:rgba(0,0,0,.4);border:1px solid rgba(212,175,55,.1);border-radius:8px;padding:16px;margin-top:16px;max-height:400px;overflow-y:auto}
.run-output pre{font-family:'Courier New',monospace;font-size:13px;line-height:1.6;white-space:pre-wrap}
.code-block{background:rgba(0,0,0,.5);border:1px solid rgba(212,175,55,.1);border-radius:8px;padding:20px;max-height:500px;overflow:auto}
.code-block pre{color:#D4AF37;font-family:'Courier New',monospace;font-size:13px;line-height:1.6;white-space:pre}
.empty{text-align:center;padding:80px 20px}
.empty .icon{font-size:64px;margin-bottom:16px}
.empty h2{font-size:22px;margin-bottom:12px;color:rgba(255,255,255,.6)}
.empty p{font-size:14px;color:rgba(255,255,255,.4);max-width:400px;margin:0 auto 24px}
.footer{text-align:center;padding:40px;font-size:12px;color:rgba(255,255,255,.25)}
.section-title{font-size:14px;font-weight:600;color:#D4AF37;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(212,175,55,.15)}
.toast{position:fixed;top:20px;right:20px;padding:14px 24px;background:#34d399;color:#0B1F3A;border-radius:8px;font-weight:600;font-size:14px;z-index:200;display:none}
.toast.show{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.deploy-tabs{display:flex;gap:8px;border-bottom:1px solid rgba(212,175,55,.12);padding-bottom:12px;margin-bottom:16px}
.deploy-tab{padding:8px 12px;border:1px solid rgba(212,175,55,.2);border-radius:8px;background:rgba(255,255,255,.03);color:rgba(255,255,255,.8);font-size:13px;cursor:pointer}
.deploy-tab.active{background:rgba(212,175,55,.15);color:#D4AF37;border-color:rgba(212,175,55,.45)}
.deploy-panel{display:none}
.deploy-panel.active{display:block}
.kv{display:grid;grid-template-columns:150px 1fr auto;gap:10px;align-items:center;margin-bottom:12px}
.kv label{font-size:12px;color:rgba(255,255,255,.55)}
.kv code{background:rgba(0,0,0,.35);padding:8px 10px;border-radius:6px;border:1px solid rgba(212,175,55,.2);font-size:12px;word-break:break-all}
.btn-row{display:flex;gap:8px;flex-wrap:wrap}
.mono{font-family:'Courier New',monospace}
.deploy-box{background:rgba(0,0,0,.25);border:1px solid rgba(212,175,55,.15);border-radius:10px;padding:12px;margin-top:12px}
.test-chat{background:rgba(0,0,0,.3);border:1px solid rgba(212,175,55,.16);border-radius:10px;padding:12px}
.test-messages{height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;margin-bottom:10px}
.test-msg{padding:10px 12px;border-radius:10px;font-size:13px;line-height:1.5;max-width:90%}
.test-user{background:#D4AF37;color:#0B1F3A;align-self:flex-end;font-weight:600}
.test-bot{background:#152d4f;color:#dbe5f5;border:1px solid rgba(212,175,55,.2)}
</style>
</head>
<body>
<div class="hamburger" onclick="toggleSidebar()">&#9776;</div>
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="logo">&#9878;&#65039; Mizan Studio</div>
  <nav>
    <a href="index.html">&#127968; Home</a>
    <a href="rules.html">&#128203; Rule Editor</a>
    <a href="decide.html">&#9889; Decision Tester</a>
    <a href="audit.html">&#128202; Audit Log</a>
    <a href="agents.html" class="active">&#129302; Agent Builder</a>
    <a href="compliance.html"><span>ðŸ‡¦ðŸ‡ª</span> UAE Compliance</a>
    <a href="rag.html"><span>ðŸ“š</span> Knowledge Base</a>
    <a href="widget-demo.html"><span>ðŸ”Œ</span> Widget Demo</a>
    <a href="setup.html">&#9881;&#65039; Setup</a>
  </nav>
  <div class="version">&#128230; v1.1.0</div>
</div>

<div class="main">
  <h1>&#129302; Agent Builder</h1>
  <p class="subtitle">Create, manage, and run AI agents from the browser</p>
  <div style="margin-bottom:24px;display:flex;gap:12px">
    <button class="btn" onclick="showCreateModal()">+ Create Agent</button>
    <button class="btn btn-outline" onclick="loadAgents()">&#128260; Refresh</button>
  </div>
  <div class="cards-grid" id="agentCards"></div>
  <div id="emptyState"></div>
  <div class="footer">&#9878;&#65039; Mizan Framework SDK v1.1.0 | Built by mizanuae10x</div>
</div>

<div id="toast" class="toast"></div>

<!-- CREATE AGENT MODAL -->
<div class="modal-bg" id="createModal">
  <div class="modal">
    <h2>&#10024; Create New Agent</h2>
    <p class="modal-subtitle">Configure your agent type, tools, and governance rules</p>

    <div class="section-title">1. Agent Identity</div>
    <div class="form-group">
      <label>Agent Name</label>
      <input id="agentName" placeholder="e.g. Procurement Guardian">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="agentDesc" rows="2" placeholder="What does this agent do?"></textarea>
    </div>

    <div class="section-title">2. Agent Type</div>
    <div class="type-selector" id="typeSelector">
      <div class="type-option" data-type="governance" onclick="selectType(this)">
        <div class="emoji">&#9878;&#65039;</div>
        <div class="name">Governance</div>
        <div class="tdesc">Rules-based decisions</div>
      </div>
      <div class="type-option" data-type="research" onclick="selectType(this)">
        <div class="emoji">&#128270;</div>
        <div class="name">Research</div>
        <div class="tdesc">Search &amp; analyze</div>
      </div>
      <div class="type-option" data-type="chat" onclick="selectType(this)">
        <div class="emoji">&#128172;</div>
        <div class="name">Chat</div>
        <div class="tdesc">Conversational + memory</div>
      </div>
      <div class="type-option" data-type="compliance" onclick="selectType(this)">
        <div class="emoji">&#128221;</div>
        <div class="name">Compliance</div>
        <div class="tdesc">Policy checking</div>
      </div>
      <div class="type-option" data-type="data" onclick="selectType(this)">
        <div class="emoji">&#128200;</div>
        <div class="name">Data</div>
        <div class="tdesc">Analyze &amp; calculate</div>
      </div>
      <div class="type-option" data-type="custom" onclick="selectType(this)">
        <div class="emoji">&#128736;&#65039;</div>
        <div class="name">Custom</div>
        <div class="tdesc">Build your own</div>
      </div>
    </div>

    <div class="section-title" style="margin-top:24px">3. Tools</div>
    <div class="tools-grid" id="toolsGrid">
      <div class="tool-check" onclick="toggleTool(this)">
        <input type="checkbox" value="webSearchTool">
        <div><div class="tname">&#127760; Web Search</div><div class="tdesc2">Search the internet</div></div>
      </div>
      <div class="tool-check" onclick="toggleTool(this)">
        <input type="checkbox" value="calculatorTool">
        <div><div class="tname">&#129518; Calculator</div><div class="tdesc2">Math expressions</div></div>
      </div>
      <div class="tool-check" onclick="toggleTool(this)">
        <input type="checkbox" value="dateTimeTool">
        <div><div class="tname">&#128197; Date/Time</div><div class="tdesc2">Current date &amp; time</div></div>
      </div>
      <div class="tool-check" onclick="toggleTool(this)">
        <input type="checkbox" value="httpTool">
        <div><div class="tname">&#128279; HTTP Request</div><div class="tdesc2">Call external APIs</div></div>
      </div>
      <div class="tool-check" onclick="toggleTool(this)">
        <input type="checkbox" value="fileReaderTool">
        <div><div class="tname">&#128196; File Reader</div><div class="tdesc2">Read local files</div></div>
      </div>
    </div>

    <div class="section-title" style="margin-top:24px">4. Governance Rules <span style="font-weight:400;color:rgba(255,255,255,.3)">(optional)</span></div>
    <div id="rulesContainer">
      <div id="rulesList"></div>
      <button class="btn btn-outline btn-sm" onclick="addRuleRow()" style="margin-top:4px">+ Add Rule</button>
    </div>

    <div class="section-title" style="margin-top:24px">5. LLM Model</div>
    <div class="form-group">
      <select id="agentModel">
        <optgroup label="OpenAI â€” GPT-5">
          <option value="gpt-5.2">GPT-5.2 (newest, most capable)</option>
        </optgroup>
        <optgroup label="OpenAI â€” GPT-4o">
          <option value="gpt-4o">GPT-4o (flagship)</option>
          <option value="gpt-4o-mini" selected>GPT-4o Mini (fast, affordable)</option>
        </optgroup>
        <optgroup label="OpenAI â€” o-series (Reasoning)">
          <option value="o3">o3 (most powerful reasoning)</option>
          <option value="o3-mini">o3-mini (fast reasoning)</option>
          <option value="o4-mini">o4-mini (newest reasoning)</option>
          <option value="o1">o1 (advanced reasoning)</option>
          <option value="o1-mini">o1-mini (fast reasoning)</option>
          <option value="o1-preview">o1-preview</option>
        </optgroup>
        <optgroup label="OpenAI â€” GPT-4.1">
          <option value="gpt-4.1">GPT-4.1 (latest)</option>
          <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
          <option value="gpt-4.1-nano">GPT-4.1 Nano (fastest)</option>
        </optgroup>
        <optgroup label="OpenAI â€” Legacy">
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
          <option value="gpt-4">GPT-4</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </optgroup>
        <optgroup label="Anthropic â€” Claude">
          <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
          <option value="claude-opus-4-20250514">Claude Opus 4</option>
          <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
          <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku (fast)</option>
        </optgroup>
      </select>
    </div>

    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:16px;border-top:1px solid rgba(212,175,55,.1)">
      <button class="btn btn-outline" onclick="hideCreateModal()">Cancel</button>
      <button class="btn" onclick="createAgent()">&#129302; Create Agent</button>
    </div>
  </div>
</div>

<!-- RUN AGENT MODAL -->
<div class="modal-bg" id="runModal">
  <div class="modal">
    <h2 id="runTitle">&#9889; Run Agent</h2>
    <div class="form-group">
      <label>Input (JSON)</label>
      <textarea id="runInput" rows="4" placeholder='{"query": "What is UAE AI strategy?"}'></textarea>
      <div class="hint">Provide a JSON object as input to the agent</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-green" onclick="executeAgent()" id="runBtn">&#9654; Run</button>
      <button class="btn btn-outline" onclick="hideRunModal()">Close</button>
    </div>
    <div class="run-output" id="runOutput" style="display:none">
      <pre id="runOutputText"></pre>
    </div>
  </div>
</div>

<!-- VIEW CODE MODAL -->
<div class="modal-bg" id="codeModal">
  <div class="modal">
    <h2 id="codeTitle">&#128196; Agent Code</h2>
    <p class="modal-subtitle" id="codeFilename"></p>
    <div class="code-block">
      <pre id="codeContent"></pre>
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-outline" onclick="copyCode()">&#128203; Copy</button>
      <button class="btn btn-outline" onclick="hideCodeModal()">Close</button>
    </div>
  </div>
</div>

<!-- DEPLOY MODAL -->
<div class="modal-bg" id="deployModal">
  <div class="modal" style="width:860px">
    <h2 id="deployTitle">ðŸš€ Deploy Agent</h2>
    <p class="modal-subtitle" id="deploySubtitle">Configure API keys, website embed, and test chat.</p>

    <div class="deploy-tabs">
      <button class="deploy-tab active" onclick="setDeployTab('api')" id="tab-api">API</button>
      <button class="deploy-tab" onclick="setDeployTab('embed')" id="tab-embed">Embed</button>
      <button class="deploy-tab" onclick="setDeployTab('test')" id="tab-test">Test</button>
    </div>

    <div class="deploy-panel active" id="panel-api">
      <div class="kv">
        <label>API Endpoint</label>
        <code id="apiEndpoint" class="mono"></code>
        <button class="btn btn-outline btn-sm" onclick="copyApiEndpoint()">Copy URL</button>
      </div>
      <div class="kv">
        <label>API Key</label>
        <code id="apiKeyMask" class="mono">mzn_k_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</code>
        <div class="btn-row">
          <button class="btn btn-sm" onclick="generateDeployKey()">Generate New Key</button>
          <button class="btn btn-outline btn-sm" onclick="copyApiKey()">Copy</button>
          <button class="btn btn-red btn-sm" onclick="revokeApiKey()">Revoke</button>
        </div>
      </div>
      <div class="kv" style="grid-template-columns:150px 1fr">
        <label>Usage</label>
        <div id="apiStats" style="font-size:13px;color:rgba(255,255,255,.6)">Never used Â· 0 calls total</div>
      </div>
      <div class="deploy-box">
        <div style="font-size:13px;color:#D4AF37;margin-bottom:8px">Example cURL</div>
        <pre id="curlExample" class="mono" style="white-space:pre-wrap;font-size:12px;color:#d6e4fb"></pre>
        <button class="btn btn-outline btn-sm" onclick="copyCurl()">Copy cURL</button>
      </div>
    </div>

    <div class="deploy-panel" id="panel-embed">
      <div class="deploy-box">
        <div style="font-size:13px;color:#D4AF37;margin-bottom:8px">Embed Code</div>
        <pre id="embedCode" class="mono" style="white-space:pre-wrap;font-size:12px;color:#d6e4fb"></pre>
        <button class="btn btn-outline btn-sm" onclick="copyEmbed()">Copy HTML</button>
      </div>
      <div style="margin-top:12px">
        <button class="btn btn-green btn-sm" onclick="openWidgetDemo()">Live Widget Demo â†’</button>
      </div>
    </div>

    <div class="deploy-panel" id="panel-test">
      <div class="test-chat">
        <div class="test-messages" id="testMessages">
          <div class="test-msg test-bot">Messages appear here...</div>
        </div>
        <div style="display:flex;gap:8px">
          <input id="testInput" placeholder="Ask your agent anything..." style="flex:1;padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(212,175,55,.2);border-radius:8px;color:#fff">
          <button class="btn btn-green btn-sm" onclick="sendDeployTest()" id="testSendBtn">Send</button>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:20px">
      <button class="btn btn-outline" onclick="hideDeployModal()">Close</button>
    </div>
  </div>
</div>

<script>
let selectedType = '';
let currentRunId = '';
let ruleCounter = 0;
let currentDeployAgent = null;
let latestFullKeys = {};
let currentMaskedKey = '';

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function timeAgo(iso) {
  if (!iso) return 'Never';
  var diff = Math.max(0, Date.now() - new Date(iso).getTime());
  var mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + ' min ago';
  var hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + ' hour' + (hrs !== 1 ? 's' : '') + ' ago';
  var days = Math.floor(hrs / 24);
  return days + ' day' + (days !== 1 ? 's' : '') + ' ago';
}

function hideDeployModal() { document.getElementById('deployModal').classList.remove('show'); }

function setDeployTab(tab) {
  ['api', 'embed', 'test'].forEach(function(t) {
    document.getElementById('tab-' + t).classList.toggle('active', t === tab);
    document.getElementById('panel-' + t).classList.toggle('active', t === tab);
  });
}

function updateDeploySnippets() {
  if (!currentDeployAgent) return;
  var endpoint = location.origin + '/api/agents/' + currentDeployAgent.id + '/chat';
  document.getElementById('apiEndpoint').textContent = endpoint;
  var full = latestFullKeys[currentDeployAgent.id] || '';
  var shown = full || currentMaskedKey || 'mzn_k_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  var curl = 'curl -X POST ' + endpoint + ' \\\\\\n  -H "Authorization: Bearer ' + shown + '" \\\\\\n  -H "Content-Type: application/json" \\\\\\n  -d \'{\"message\":\"Hello\"}\'';
  document.getElementById('curlExample').textContent = curl;
  var embed = '<script src=\"' + location.origin + '/widget.js\" data-agent=\"' + currentDeployAgent.id + '\" data-key=\"' + shown + '\" data-theme=\"navy\" data-lang=\"ar\"></script>';
  document.getElementById('embedCode').textContent = embed;
}

function renderDeployApiStats(keyData) {
  if (!keyData) {
    document.getElementById('apiKeyMask').textContent = 'mzn_k_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
    document.getElementById('apiStats').textContent = 'Never used Â· 0 calls total';
    currentMaskedKey = '';
  } else {
    document.getElementById('apiKeyMask').textContent = keyData.id;
    document.getElementById('apiStats').textContent = (keyData.lastUsed ? timeAgo(keyData.lastUsed) : 'Never used') + ' Â· ' + (keyData.callCount || 0) + ' calls total';
    currentMaskedKey = keyData.id;
  }
  updateDeploySnippets();
}

async function loadDeployKeys() {
  if (!currentDeployAgent) return;
  var keys = await (await fetch('/api/agents/' + currentDeployAgent.id + '/keys')).json();
  renderDeployApiStats(keys[0]);
}

async function showDeployModal(id, name) {
  currentDeployAgent = { id: id, name: name };
  document.getElementById('deployTitle').textContent = 'ðŸš€ Deploy: ' + name;
  document.getElementById('deploySubtitle').textContent = 'API, embed snippet, and live test panel for ' + name + '.';
  document.getElementById('testMessages').innerHTML = '<div class=\"test-msg test-bot\">Messages appear here...</div>';
  document.getElementById('testInput').value = '';
  setDeployTab('api');
  updateDeploySnippets();
  await loadDeployKeys();
  document.getElementById('deployModal').classList.add('show');
}

async function generateDeployKey() {
  if (!currentDeployAgent) return;
  var name = prompt('Key name', 'Production Key') || 'Production Key';
  var res = await fetch('/api/agents/' + currentDeployAgent.id + '/keys', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name })
  });
  var data = await res.json();
  if (data.error) { alert(data.error); return; }
  latestFullKeys[currentDeployAgent.id] = data.key;
  await loadDeployKeys();
  showToast('API key generated');
}

function copyApiEndpoint() {
  navigator.clipboard.writeText(document.getElementById('apiEndpoint').textContent);
  showToast('Endpoint copied');
}

function copyApiKey() {
  if (!currentDeployAgent) return;
  var val = latestFullKeys[currentDeployAgent.id] || currentMaskedKey || '';
  if (!val) { alert('Generate a key first'); return; }
  navigator.clipboard.writeText(val);
  showToast('API key copied');
}

async function revokeApiKey() {
  if (!currentDeployAgent || !currentMaskedKey) { alert('No key to revoke'); return; }
  if (!confirm('Revoke this API key?')) return;
  var res = await fetch('/api/agents/' + currentDeployAgent.id + '/keys/' + encodeURIComponent(currentMaskedKey), { method: 'DELETE' });
  var data = await res.json();
  if (data.error) { alert(data.error); return; }
  latestFullKeys[currentDeployAgent.id] = '';
  await loadDeployKeys();
  showToast('Key revoked');
}

function copyCurl() {
  navigator.clipboard.writeText(document.getElementById('curlExample').textContent);
  showToast('cURL copied');
}

function copyEmbed() {
  navigator.clipboard.writeText(document.getElementById('embedCode').textContent);
  showToast('Embed HTML copied');
}

function openWidgetDemo() {
  window.open('widget-demo.html', '_blank');
}

function addTestMessage(text, who) {
  var wrap = document.getElementById('testMessages');
  var div = document.createElement('div');
  div.className = 'test-msg ' + (who === 'user' ? 'test-user' : 'test-bot');
  div.textContent = text;
  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
}

async function sendDeployTest() {
  if (!currentDeployAgent) return;
  var input = document.getElementById('testInput');
  var msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  addTestMessage(msg, 'user');
  var btn = document.getElementById('testSendBtn');
  btn.disabled = true;
  addTestMessage('Thinking...', 'bot');
  var wrap = document.getElementById('testMessages');
  var typing = wrap.lastElementChild;
  try {
    var full = latestFullKeys[currentDeployAgent.id] || '';
    var endpoint = full ? '/api/agents/' + currentDeployAgent.id + '/chat' : '/api/agents/' + currentDeployAgent.id + '/chat/public';
    var resp = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(full ? { Authorization: 'Bearer ' + full } : {})
      },
      body: JSON.stringify({ message: msg, session_id: 'studio-test-' + Date.now() })
    });
    var data = await resp.json();
    typing.remove();
    addTestMessage(data.answer || data.error || 'No response', 'bot');
  } catch (e) {
    typing.remove();
    addTestMessage('Connection error. Please try again.', 'bot');
  }
  btn.disabled = false;
}

function selectType(el) {
  document.querySelectorAll('.type-option').forEach(function(o){ o.classList.remove('selected'); });
  el.classList.add('selected');
  selectedType = el.dataset.type;
  var toolMap = {
    governance: [],
    research: ['webSearchTool'],
    chat: ['dateTimeTool'],
    compliance: ['webSearchTool'],
    data: ['calculatorTool', 'dateTimeTool'],
    custom: []
  };
  document.querySelectorAll('.tool-check').forEach(function(tc) {
    var cb = tc.querySelector('input');
    var shouldCheck = (toolMap[selectedType] || []).indexOf(cb.value) !== -1;
    cb.checked = shouldCheck;
    if (shouldCheck) tc.classList.add('checked');
    else tc.classList.remove('checked');
  });
}

function toggleTool(el) {
  var cb = el.querySelector('input');
  cb.checked = !cb.checked;
  if (cb.checked) el.classList.add('checked');
  else el.classList.remove('checked');
}

function addRuleRow(rule) {
  ruleCounter++;
  var div = document.createElement('div');
  div.className = 'rule-row';
  div.innerHTML = '<input placeholder="Rule name" value="' + (rule && rule.name ? rule.name : '') + '" class="rname">' +
    '<input placeholder="Condition (e.g. score >= 70)" value="' + (rule && rule.condition ? rule.condition : '') + '" class="rcondition">' +
    '<select class="raction"><option' + (rule && rule.action === 'APPROVED' ? ' selected' : '') + '>APPROVED</option><option' + (rule && rule.action === 'REJECTED' ? ' selected' : '') + '>REJECTED</option><option' + (rule && rule.action === 'REVIEW' ? ' selected' : '') + '>REVIEW</option></select>' +
    '<input type="number" placeholder="Pri" value="' + (rule && rule.priority ? rule.priority : 1) + '" min="0" max="5" class="rpriority">' +
    '<button class="remove-rule" onclick="this.parentElement.remove()">&times;</button>';
  document.getElementById('rulesList').appendChild(div);
}

function getRules() {
  var rules = [];
  document.querySelectorAll('.rule-row').forEach(function(row, i) {
    var name = row.querySelector('.rname').value;
    var condition = row.querySelector('.rcondition').value;
    if (!name || !condition) return;
    rules.push({
      id: 'R' + (i + 1), name: name, condition: condition,
      action: row.querySelector('.raction').value,
      reason: name,
      priority: parseInt(row.querySelector('.rpriority').value) || 1
    });
  });
  return rules;
}

function showCreateModal() {
  document.getElementById('createModal').classList.add('show');
  document.getElementById('agentName').value = '';
  document.getElementById('agentDesc').value = '';
  document.getElementById('agentModel').value = 'gpt-4o-mini';
  selectedType = '';
  document.querySelectorAll('.type-option').forEach(function(o){ o.classList.remove('selected'); });
  document.querySelectorAll('.tool-check').forEach(function(tc) {
    tc.querySelector('input').checked = false;
    tc.classList.remove('checked');
  });
  document.getElementById('rulesList').innerHTML = '';
  ruleCounter = 0;
}

function hideCreateModal() { document.getElementById('createModal').classList.remove('show'); }

async function createAgent() {
  var name = document.getElementById('agentName').value.trim();
  if (!name) { alert('Please enter an agent name'); return; }
  if (!selectedType) { alert('Please select an agent type'); return; }

  var tools = [];
  document.querySelectorAll('.tool-check input:checked').forEach(function(cb){ tools.push(cb.value); });

  var body = {
    name: name, type: selectedType,
    description: document.getElementById('agentDesc').value.trim(),
    model: document.getElementById('agentModel').value,
    tools: tools, rules: getRules()
  };

  var res = await fetch('/api/agents', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  var agent = await res.json();
  if (agent.error) { alert(agent.error); return; }
  hideCreateModal();
  showToast('Agent "' + name + '" created!');
  loadAgents();
  showDeployModal(agent.id, agent.name || name);
}

function showRunModal(id, name) {
  currentRunId = id;
  document.getElementById('runTitle').innerHTML = '&#9889; Run: ' + name;
  document.getElementById('runInput').value = '{"query": "Hello, what can you do?"}';
  document.getElementById('runOutput').style.display = 'none';
  document.getElementById('runBtn').disabled = false;
  document.getElementById('runBtn').innerHTML = '&#9654; Run';
  document.getElementById('runModal').classList.add('show');
}
function hideRunModal() { document.getElementById('runModal').classList.remove('show'); }

async function executeAgent() {
  var btn = document.getElementById('runBtn');
  btn.disabled = true;
  btn.textContent = 'Running...';

  var input;
  try { input = JSON.parse(document.getElementById('runInput').value); }
  catch(e) { alert('Invalid JSON input'); btn.disabled = false; btn.innerHTML = '&#9654; Run'; return; }

  var res = await fetch('/api/agents/' + currentRunId + '/run', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ input: input })
  });
  var result = await res.json();

  var outputEl = document.getElementById('runOutput');
  var textEl = document.getElementById('runOutputText');
  outputEl.style.display = 'block';

  if (result.success) {
    textEl.textContent = result.output;
    textEl.style.color = '#34d399';
  } else {
    textEl.textContent = 'ERROR:\n' + (result.error || 'Unknown error') + (result.output ? '\n\nOutput:\n' + result.output : '');
    textEl.style.color = '#ef4444';
  }
  btn.disabled = false;
  btn.innerHTML = '&#9654; Run Again';
  loadAgents();
}

async function showCodeModal(id, name) {
  document.getElementById('codeTitle').textContent = name;
  document.getElementById('codeContent').textContent = 'Loading...';
  document.getElementById('codeFilename').textContent = '';
  document.getElementById('codeModal').classList.add('show');
  var res = await fetch('/api/agents/' + id + '/code');
  var data = await res.json();
  document.getElementById('codeContent').textContent = data.code || 'File not found';
  document.getElementById('codeFilename').textContent = 'File: agents/' + (data.filename || '');
}
function hideCodeModal() { document.getElementById('codeModal').classList.remove('show'); }
function copyCode() {
  navigator.clipboard.writeText(document.getElementById('codeContent').textContent);
  showToast('Code copied!');
}

async function deleteAgent(id, name) {
  if (!confirm('Delete agent "' + name + '"?')) return;
  await fetch('/api/agents/' + id, { method: 'DELETE' });
  showToast('Agent deleted');
  loadAgents();
}

async function loadAgents() {
  var agents = await (await fetch('/api/agents')).json();
  var cards = document.getElementById('agentCards');
  var empty = document.getElementById('emptyState');

  if (!agents.length) {
    cards.innerHTML = '';
    empty.innerHTML = '<div class="empty"><div class="icon">&#129302;</div><h2>No agents yet</h2><p>Create your first AI agent. Choose a type, add tools, set rules, and deploy!</p><button class="btn" onclick="showCreateModal()">+ Create Your First Agent</button></div>';
    return;
  }

  empty.innerHTML = '';
  cards.innerHTML = agents.map(function(a) {
    var typeClass = 'type-' + (a.type || 'custom');
    var dotClass = a.status === 'running' ? 'dot-running' : 'dot-idle';
    var toolCount = (a.tools || []).length;
    var ruleCount = (a.rules || []).length;
    var lastAct = a.lastActivity ? new Date(a.lastActivity).toLocaleString() : 'Never';
    var safeName = (a.name || '').replace(/'/g, "\\'");
    return '<div class="agent-card" style="cursor:pointer" onclick="showDeployModal(\'' + a.id + '\',\'' + safeName + '\')">' +
      '<div class="card-header"><h3>' + a.name + '</h3><span class="type-badge ' + typeClass + '">' + (a.type || 'custom') + '</span></div>' +
      '<div class="desc">' + (a.description || 'No description') + '</div>' +
      '<div class="meta">' +
        '<span><span class="status-dot ' + dotClass + '"></span> ' + (a.status || 'idle') + '</span>' +
        '<span>&#128202; ' + (a.decisions || 0) + ' runs</span>' +
        '<span>&#128295; ' + toolCount + ' tool' + (toolCount !== 1 ? 's' : '') + '</span>' +
        '<span>&#128203; ' + ruleCount + ' rule' + (ruleCount !== 1 ? 's' : '') + '</span>' +
        '<span>&#128337; ' + lastAct + '</span>' +
        '<span>&#129302; ' + (a.model || 'gpt-4o-mini') + '</span>' +
      '</div>' +
      '<div class="actions">' +
        '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();showDeployModal(\'' + a.id + '\',\'' + safeName + '\')">ðŸš€ Deploy</button>' +
        '<button class="btn btn-green btn-sm" onclick="event.stopPropagation();showRunModal(\'' + a.id + '\',\'' + safeName + '\')">&#9654; Run</button>' +
        '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();showCodeModal(\'' + a.id + '\',\'' + safeName + '\')">&#128196; Code</button>' +
        '<button class="btn btn-red btn-sm" onclick="event.stopPropagation();deleteAgent(\'' + a.id + '\',\'' + safeName + '\')">&#128465; Delete</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

loadAgents();
document.getElementById('testInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendDeployTest();
  }
});
</script>
</body>
</html>
